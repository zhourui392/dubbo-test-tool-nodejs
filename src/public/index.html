<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dubbo接口测试工具</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Custom styles for specific components */
        .sidebar {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .service-tree {
            list-style: none;
        }

        .service-item {
            margin-bottom: 15px;
        }

        .service-header {
            background: #f8f9fa;
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid #dee2e6;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapse-icon {
            font-size: 12px;
            margin-right: 8px;
            transition: transform 0.3s ease;
            color: #6c757d;
        }

        .collapse-icon.expanded {
            transform: rotate(90deg);
        }

        .service-header:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .service-header.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .service-name {
            font-weight: 600;
            font-size: 1.1em;
        }

        .service-config {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .service-actions {
            display: flex;
            gap: 5px;
        }

        .interfaces {
            margin-top: 10px;
            margin-left: 20px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .interfaces.expanded {
            max-height: 2000px;
        }

        .interface-item {
            margin-bottom: 10px;
        }

        .interface-header {
            background: #fff3cd;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            border: 1px solid #ffeaa7;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .interface-header span {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
            margin-right: 10px;
        }

        .interface-collapse-icon {
            font-size: 10px;
            margin-right: 6px;
            transition: transform 0.3s ease;
            color: #856404;
            flex-shrink: 0;
        }

        .interface-collapse-icon.expanded {
            transform: rotate(90deg);
        }

        .interface-header:hover {
            background: #fff3cd;
            border-color: #fdcb6e;
        }

        .interface-actions {
            display: flex;
            gap: 5px;
        }

        .methods {
            margin-top: 8px;
            margin-left: 15px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .methods.expanded {
            max-height: 1000px;
        }

        .method-item {
            padding: 6px 12px;
            background: #f1f3f4;
            margin-bottom: 5px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .method-item:hover {
            background: #e8f0fe;
            border-color: #4285f4;
        }

        .method-item.is-active {
            background: #4285f4;
            color: white;
        }

        .test-panel {
            display: none;
        }

        .test-panel.is-active {
            display: block;
        }

        .result-content {
            background: #fff;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            white-space: pre-wrap;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
        }

        .loading {
            text-align: center;
            color: #667eea;
            font-style: italic;
        }

        .error {
            color: #dc3545;
            background: #f8d7da;
            border-color: #f5c6cb;
        }

        .success {
            color: #155724;
            background: #d4edda;
            border-color: #c3e6cb;
        }

        .config-info {
            font-size: 0.85em;
            color: #6c757d;
            margin-top: 5px;
        }

        .hero {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin-bottom: 30px;
        }

        .action-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .action-btn:hover {
            background: #5a6268;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .edit-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .edit-btn:hover {
            background: #218838;
        }

        .add-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .add-btn:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <!-- Hero Section -->
    <section class="hero is-primary is-small">
        <div class="hero-body">
            <div class="container has-text-centered">
                <h1 class="title is-3">
                    <span class="icon is-medium">
                        <i class="fas fa-wrench"></i>
                    </span>
                    Dubbo接口测试工具
                </h1>
                <p class="subtitle is-5">Node.js版本 - 支持Dubbo RPC接口测试</p>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <section class="section">
        <div class="container is-fluid">
            <div class="columns is-gapless">
                <!-- Sidebar -->
                <div class="column is-3">
                    <div class="sidebar">
                        <div class="field has-addons" style="margin-bottom: 20px;">
                            <p class="control">
                                <button class="button is-small is-success" onclick="app.showAddServiceModal()">
                                    <span class="icon is-small">
                                        <i class="fas fa-plus"></i>
                                    </span>
                                    <span>添加服务</span>
                                </button>
                            </p>
                            <p class="control">
                                <button class="button is-small is-info" onclick="app.refreshServices()">
                                    <span class="icon is-small">
                                        <i class="fas fa-sync"></i>
                                    </span>
                                    <span>刷新</span>
                                </button>
                            </p>
                        </div>
                        
                        <h3 class="title is-5 has-text-grey">
                            <span class="icon">
                                <i class="fas fa-list"></i>
                            </span>
                            服务列表
                        </h3>
                        <ul id="service-tree" class="service-tree">
                            <li class="has-text-grey has-text-centered" style="padding: 40px 20px; font-style: italic;">正在加载服务...</li>
                        </ul>
                    </div>
                </div>

                <!-- Content Area -->
                <div class="column is-9">
                    <div class="box">
                        <div id="welcome-panel">
                            <div class="has-text-centered has-text-grey" style="padding: 40px 20px;">
                                <h3 class="title is-4">
                                    <span class="icon">
                                        <i class="fas fa-hand-wave"></i>
                                    </span>
                                    欢迎使用Dubbo测试工具
                                </h3>
                                <p class="subtitle is-6">请从左侧选择要测试的方法</p>
                                <br>
                                <div class="content">
                                    <p class="has-text-weight-bold">
                                        <span class="icon">
                                            <i class="fas fa-lightbulb"></i>
                                        </span>
                                        使用说明：
                                    </p>
                                    <ul class="has-text-left" style="display: inline-block;">
                                        <li>点击"<span class="icon is-small"><i class="fas fa-plus"></i></span> 添加服务"创建新服务</li>
                                        <li>点击"<span class="icon is-small"><i class="fas fa-edit"></i></span>"可编辑服务、接口或方法</li>
                                        <li>点击"<span class="icon is-small"><i class="fas fa-trash"></i></span>"可删除服务、接口或方法</li>
                                        <li>点击"<span class="icon is-small"><i class="fas fa-plus"></i></span>"可添加接口或方法</li>
                                        <li>选择方法后可直接测试Dubbo接口</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div id="test-panel" class="test-panel">
                            <h3 id="method-title" class="title is-4">方法测试</h3>
                            
                            <div class="field">
                                <label class="label" for="interface-name">接口名称</label>
                                <div class="control">
                                    <input type="text" id="interface-name" class="input" readonly>
                                </div>
                            </div>

                            <div class="field">
                                <label class="label" for="method-name">方法名称</label>
                                <div class="control">
                                    <input type="text" id="method-name" class="input" readonly>
                                </div>
                            </div>

                            <div class="field">
                                <label class="label" for="params-input">
                                    请求参数 (JSON格式)
                                    <button id="format-json-btn" class="button is-small is-info" style="margin-left: 10px;">
                                        <span class="icon is-small">
                                            <i class="fas fa-palette"></i>
                                        </span>
                                        <span>格式化JSON</span>
                                    </button>
                                </label>
                                <div class="control">
                                    <textarea id="params-input" class="textarea" placeholder='{"userId": "123"}' rows="6"></textarea>
                                </div>
                            </div>

                            <div class="field">
                                <div class="control">
                                    <button id="test-btn" class="button is-primary is-medium">
                                        <span class="icon">
                                            <i class="fas fa-flask"></i>
                                        </span>
                                        <span>测试接口</span>
                                    </button>
                                </div>
                            </div>

                            <div id="result-panel" class="notification" style="display: none; margin-top: 30px;">
                                <div class="subtitle is-6 has-text-weight-bold">
                                    <span class="icon">
                                        <i class="fas fa-clipboard-list"></i>
                                    </span>
                                    响应结果
                                </div>
                                <div id="result-content" class="result-content"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Service Modal -->
    <div id="service-modal" class="modal">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title" id="service-modal-title">添加服务</p>
                <button class="delete" onclick="app.hideServiceModal()"></button>
            </header>
            <section class="modal-card-body">
                <form id="service-form">
                    <div class="field">
                        <label class="label" for="service-name">服务名称</label>
                        <div class="control">
                            <input type="text" id="service-name" class="input" required>
                        </div>
                    </div>
                    <div class="field">
                        <label class="label" for="service-host">主机地址</label>
                        <div class="control">
                            <input type="text" id="service-host" class="input" value="127.0.0.1" required>
                        </div>
                    </div>
                    <div class="field">
                        <label class="label" for="service-port">端口号</label>
                        <div class="control">
                            <input type="number" id="service-port" class="input" value="20880" required>
                        </div>
                    </div>
                    <div class="field">
                        <label class="label" for="service-timeout">超时时间(ms)</label>
                        <div class="control">
                            <input type="number" id="service-timeout" class="input" value="5000" required>
                        </div>
                    </div>
                    <div class="field">
                        <label class="label" for="service-version">版本号(可选)</label>
                        <div class="control">
                            <input type="text" id="service-version" class="input">
                        </div>
                    </div>
                    <div class="field">
                        <label class="label" for="service-group">分组(可选)</label>
                        <div class="control">
                            <input type="text" id="service-group" class="input">
                        </div>
                    </div>
                </form>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-success" onclick="app.saveService()">保存</button>
                <button class="button" onclick="app.hideServiceModal()">取消</button>
            </footer>
        </div>
    </div>

    <!-- Interface Modal -->
    <div id="interface-modal" class="modal">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title" id="interface-modal-title">添加接口</p>
                <button class="delete" onclick="app.hideInterfaceModal()"></button>
            </header>
            <section class="modal-card-body">
                <form id="interface-form">
                    <div class="field">
                        <label class="label" for="interface-name-input">接口名称</label>
                        <div class="control">
                            <input type="text" id="interface-name-input" class="input" required 
                                   placeholder="com.example.UserService">
                        </div>
                    </div>
                </form>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-success" onclick="app.saveInterface()">保存</button>
                <button class="button" onclick="app.hideInterfaceModal()">取消</button>
            </footer>
        </div>
    </div>

    <!-- Method Modal -->
    <div id="method-modal" class="modal">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title" id="method-modal-title">添加方法</p>
                <button class="delete" onclick="app.hideMethodModal()"></button>
            </header>
            <section class="modal-card-body">
                <form id="method-form">
                    <div class="field">
                        <label class="label" for="method-name-input">方法名称</label>
                        <div class="control">
                            <input type="text" id="method-name-input" class="input" required 
                                   placeholder="getUserInfo">
                        </div>
                    </div>
                    <div class="field">
                        <label class="label" for="method-params">
                            默认参数(JSON格式) 
                            <button id="format-method-json-btn" class="button is-small is-info" style="margin-left: 10px;">
                                <span class="icon is-small">
                                    <i class="fas fa-palette"></i>
                                </span>
                                <span>格式化JSON</span>
                            </button>
                        </label>
                        <div class="control">
                            <textarea id="method-params" class="textarea" 
                                      placeholder='{"userId": "123"}'>{}</textarea>
                        </div>
                    </div>
                    <div class="field">
                        <label class="label" for="method-return-type">返回类型(可选)</label>
                        <div class="control">
                            <input type="text" id="method-return-type" class="input" 
                                   placeholder="UserDTO">
                        </div>
                    </div>
                    <div class="field">
                        <label class="label" for="method-description">方法描述(可选)</label>
                        <div class="control">
                            <input type="text" id="method-description" class="input" 
                                   placeholder="获取用户信息">
                        </div>
                    </div>
                </form>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-success" onclick="app.saveMethod()">保存</button>
                <button class="button" onclick="app.hideMethodModal()">取消</button>
            </footer>
        </div>
    </div>

    <script>
        class DubboTestUI {
            constructor() {
                this.socket = io();
                this.currentMethod = null;
                this.services = [];
                this.editingService = null;
                this.editingInterface = null;
                this.editingMethod = null;
                this.collapsedStates = {
                    services: {},
                    interfaces: {}
                };
                
                this.loadCollapsedStates();
                this.initEventListeners();
                this.initSocketListeners();
                this.loadServices();
            }

            // 从完整接口名提取简短显示名
            getShortInterfaceName(fullName) {
                if (!fullName) return fullName;
                
                // 如果是完整的类名（包含包名），提取类名
                const parts = fullName.split('.');
                if (parts.length > 1) {
                    return parts[parts.length - 1]; // 返回最后一部分（类名）
                }
                
                return fullName; // 如果不包含包名，直接返回
            }

            initEventListeners() {
                document.getElementById('test-btn').addEventListener('click', () => {
                    this.testMethod();
                });

                document.getElementById('format-json-btn').addEventListener('click', () => {
                    this.formatJsonParams();
                });

                document.getElementById('format-method-json-btn').addEventListener('click', () => {
                    this.formatMethodJsonParams();
                });

                // Close modals when clicking outside
                window.addEventListener('click', (event) => {
                    if (event.target.classList.contains('modal-background')) {
                        this.hideAllModals();
                    }
                });
            }

            initSocketListeners() {
                this.socket.on('services-data', (response) => {
                    if (response.success) {
                        this.services = response.data;
                        this.renderServices();
                    } else {
                        this.showError('加载服务失败: ' + response.error);
                    }
                });

                this.socket.on('test-start', (data) => {
                    this.showLoading(data.message);
                });

                this.socket.on('test-result', (response) => {
                    if (response.success) {
                        this.showResult(response.data, 'success');
                    } else {
                        this.showResult(response.error, 'error');
                    }
                });
            }

            loadServices() {
                this.socket.emit('get-services');
            }

            refreshServices() {
                this.loadServices();
            }

            // Service Modal Methods
            showAddServiceModal() {
                this.editingService = null;
                document.getElementById('service-modal-title').textContent = '添加服务';
                document.getElementById('service-form').reset();
                document.getElementById('service-modal').classList.add('is-active');
            }

            showEditServiceModal(serviceId) {
                const service = this.services.find(s => s.id === serviceId);
                if (!service) return;

                this.editingService = service;
                document.getElementById('service-modal-title').textContent = '编辑服务';
                document.getElementById('service-name').value = service.name;
                document.getElementById('service-host').value = service.dubbo_config.host;
                document.getElementById('service-port').value = service.dubbo_config.port;
                document.getElementById('service-timeout').value = service.dubbo_config.timeout;
                document.getElementById('service-version').value = service.dubbo_config.version || '';
                document.getElementById('service-group').value = service.dubbo_config.group || '';
                document.getElementById('service-modal').classList.add('is-active');
            }

            hideServiceModal() {
                document.getElementById('service-modal').classList.remove('is-active');
                this.editingService = null;
            }

            async saveService() {
                const name = document.getElementById('service-name').value.trim();
                const host = document.getElementById('service-host').value.trim();
                const port = parseInt(document.getElementById('service-port').value);
                const timeout = parseInt(document.getElementById('service-timeout').value);
                const version = document.getElementById('service-version').value.trim();
                const group = document.getElementById('service-group').value.trim();

                if (!name || !host || !port || !timeout) {
                    alert('请填写必要字段');
                    return;
                }

                try {
                    const data = {
                        name,
                        dubboConfig: { host, port, timeout, version, group }
                    };

                    let response;
                    if (this.editingService) {
                        // Update service
                        response = await fetch(`/api/services/${this.editingService.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });
                    } else {
                        // Add service
                        response = await fetch('/api/services', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });
                    }

                    if (response.ok) {
                        alert(this.editingService ? '服务更新成功！' : '服务添加成功！');
                        this.hideServiceModal();
                        this.loadServices();
                    } else {
                        alert('操作失败！');
                    }
                } catch (error) {
                    alert('操作失败: ' + error.message);
                }
            }

            // Interface Modal Methods
            showAddInterfaceModal(serviceId) {
                this.editingInterface = { serviceId };
                document.getElementById('interface-modal-title').textContent = '添加接口';
                document.getElementById('interface-form').reset();
                document.getElementById('interface-modal').classList.add('is-active');
            }

            showEditInterfaceModal(serviceId, interfaceId) {
                const service = this.services.find(s => s.id === serviceId);
                const iface = service.interfaces.find(i => i.id === interfaceId);
                if (!iface) return;

                this.editingInterface = { serviceId, interfaceId, interface: iface };
                document.getElementById('interface-modal-title').textContent = '编辑接口';
                document.getElementById('interface-name-input').value = iface.name; // 显示完整接口名用于编辑
                document.getElementById('interface-modal').classList.add('is-active');
            }

            hideInterfaceModal() {
                document.getElementById('interface-modal').classList.remove('is-active');
                this.editingInterface = null;
            }

            async saveInterface() {
                const name = document.getElementById('interface-name-input').value.trim();

                if (!name) {
                    alert('请输入接口名称');
                    return;
                }

                try {
                    let response;
                    if (this.editingInterface.interfaceId) {
                        // Update interface
                        response = await fetch(`/api/services/${this.editingInterface.serviceId}/interfaces/${this.editingInterface.interfaceId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name })
                        });
                    } else {
                        // Add interface
                        response = await fetch(`/api/services/${this.editingInterface.serviceId}/interfaces`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name })
                        });
                    }

                    if (response.ok) {
                        alert(this.editingInterface.interfaceId ? '接口更新成功！' : '接口添加成功！');
                        this.hideInterfaceModal();
                        this.loadServices();
                    } else {
                        alert('操作失败！');
                    }
                } catch (error) {
                    alert('操作失败: ' + error.message);
                }
            }

            // Method Modal Methods
            showAddMethodModal(serviceId, interfaceId) {
                this.editingMethod = { serviceId, interfaceId };
                document.getElementById('method-modal-title').textContent = '添加方法';
                document.getElementById('method-form').reset();
                document.getElementById('method-params').value = '{}';
                document.getElementById('method-modal').classList.add('is-active');
            }

            showEditMethodModal(serviceId, interfaceId, methodId) {
                const service = this.services.find(s => s.id === serviceId);
                const iface = service.interfaces.find(i => i.id === interfaceId);
                const method = iface.methods.find(m => m.id === methodId);
                if (!method) return;

                this.editingMethod = { serviceId, interfaceId, methodId, method };
                document.getElementById('method-modal-title').textContent = '编辑方法';
                document.getElementById('method-name-input').value = method.name;
                document.getElementById('method-params').value = method.params;
                document.getElementById('method-return-type').value = method.return_type || '';
                document.getElementById('method-description').value = method.description || '';
                document.getElementById('method-modal').classList.add('is-active');
            }

            hideMethodModal() {
                document.getElementById('method-modal').classList.remove('is-active');
                this.editingMethod = null;
            }

            async saveMethod() {
                const name = document.getElementById('method-name-input').value.trim();
                const params = document.getElementById('method-params').value.trim();
                const returnType = document.getElementById('method-return-type').value.trim();
                const description = document.getElementById('method-description').value.trim();

                if (!name) {
                    alert('请输入方法名称');
                    return;
                }

                try {
                    const data = { name, params, returnType, description };

                    let response;
                    if (this.editingMethod.methodId) {
                        // Update method
                        response = await fetch(`/api/services/${this.editingMethod.serviceId}/interfaces/${this.editingMethod.interfaceId}/methods/${this.editingMethod.methodId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });
                    } else {
                        // Add method
                        response = await fetch(`/api/services/${this.editingMethod.serviceId}/interfaces/${this.editingMethod.interfaceId}/methods`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });
                    }

                    if (response.ok) {
                        alert(this.editingMethod.methodId ? '方法更新成功！' : '方法添加成功！');
                        this.hideMethodModal();
                        this.loadServices();
                    } else {
                        alert('操作失败！');
                    }
                } catch (error) {
                    alert('操作失败: ' + error.message);
                }
            }

            hideAllModals() {
                this.hideServiceModal();
                this.hideInterfaceModal();
                this.hideMethodModal();
            }

            // Delete Methods
            async deleteService(serviceId, event) {
                event.stopPropagation();
                
                if (!confirm('确定要删除这个服务吗？这将删除服务下的所有接口和方法。')) return;

                try {
                    const response = await fetch(`/api/services/${serviceId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        alert('服务删除成功！');
                        this.loadServices();
                    } else {
                        alert('服务删除失败！');
                    }
                } catch (error) {
                    alert('服务删除失败: ' + error.message);
                }
            }

            async deleteInterface(serviceId, interfaceId, event) {
                event.stopPropagation();
                
                if (!confirm('确定要删除这个接口吗？')) return;

                try {
                    const response = await fetch(`/api/services/${serviceId}/interfaces/${interfaceId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        alert('接口删除成功！');
                        this.loadServices();
                    } else {
                        alert('接口删除失败！');
                    }
                } catch (error) {
                    alert('接口删除失败: ' + error.message);
                }
            }

            async deleteMethod(serviceId, interfaceId, methodId, event) {
                event.stopPropagation();
                
                if (!confirm('确定要删除这个方法吗？')) return;

                try {
                    const response = await fetch(`/api/services/${serviceId}/interfaces/${interfaceId}/methods/${methodId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        alert('方法删除成功！');
                        this.loadServices();
                    } else {
                        alert('方法删除失败！');
                    }
                } catch (error) {
                    alert('方法删除失败: ' + error.message);
                }
            }

            renderServices() {
                const serviceTree = document.getElementById('service-tree');
                
                if (this.services.length === 0) {
                    serviceTree.innerHTML = '<li class="has-text-grey has-text-centered" style="padding: 40px 20px; font-style: italic;">暂无服务，请点击"添加服务"</li>';
                    return;
                }

                let html = '';
                this.services.forEach(service => {
                    html += `
                        <li class="service-item">
                            <div class="service-header" onclick="app.toggleService('${service.id}')">
                                <div style="display: flex; align-items: center;">
                                    <span class="collapse-icon" id="service-icon-${service.id}"><i class="fas fa-chevron-right"></i></span>
                                    <div>
                                        <div class="service-name">${service.name}</div>
                                        <div class="config-info">${service.dubbo_config.host}:${service.dubbo_config.port}</div>
                                    </div>
                                </div>
                                <div class="service-actions">
                                    <button class="action-btn" onclick="event.stopPropagation(); app.testConnection('${service.id}')" title="测试连接"><i class="fas fa-search"></i></button>
                                    <button class="add-btn" onclick="event.stopPropagation(); app.showAddInterfaceModal('${service.id}')" title="添加接口"><i class="fas fa-plus"></i></button>
                                    <button class="edit-btn" onclick="event.stopPropagation(); app.showEditServiceModal('${service.id}')" title="编辑服务"><i class="fas fa-edit"></i></button>
                                    <button class="delete-btn" onclick="app.deleteService('${service.id}', event)" title="删除服务">🗑️</button>
                                </div>
                            </div>
                            <ul class="interfaces" id="interfaces-${service.id}">
                                ${service.interfaces.map(iface => `
                                    <li class="interface-item">
                                        <div class="interface-header" onclick="app.toggleInterface('${service.id}', '${iface.id}')" title="${iface.name}">
                                            <span style="display: flex; align-items: center;">
                                                <span class="interface-collapse-icon" id="interface-icon-${service.id}-${iface.id}"><i class="fas fa-chevron-right"></i></span>
                                                <i class="fas fa-folder"></i> ${this.getShortInterfaceName(iface.name)}
                                            </span>
                                            <div class="interface-actions">
                                                <button class="add-btn" onclick="event.stopPropagation(); app.showAddMethodModal('${service.id}', '${iface.id}')" title="添加方法"><i class="fas fa-plus"></i></button>
                                                <button class="edit-btn" onclick="event.stopPropagation(); app.showEditInterfaceModal('${service.id}', '${iface.id}')" title="编辑接口"><i class="fas fa-edit"></i></button>
                                                <button class="delete-btn" onclick="app.deleteInterface('${service.id}', '${iface.id}', event)" title="删除接口">🗑️</button>
                                            </div>
                                        </div>
                                        <ul class="methods" id="methods-${service.id}-${iface.id}">
                                            ${iface.methods.map(method => `
                                                <li class="method-item" onclick="app.selectMethod('${service.id}', '${iface.id}', '${method.id}')">
                                                    <span><i class="fas fa-bolt"></i> ${method.name}</span>
                                                    <div class="interface-actions">
                                                        <button class="edit-btn" onclick="event.stopPropagation(); app.showEditMethodModal('${service.id}', '${iface.id}', '${method.id}')" title="编辑方法"><i class="fas fa-edit"></i></button>
                                                        <button class="delete-btn" onclick="app.deleteMethod('${service.id}', '${iface.id}', '${method.id}', event)" title="删除方法">🗑️</button>
                                                    </div>
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </li>
                                `).join('')}
                            </ul>
                        </li>
                    `;
                });

                serviceTree.innerHTML = html;
                
                // 应用之前保存的折叠状态
                setTimeout(() => {
                    this.applyCollapsedStates();
                }, 50);
            }

            selectMethod(serviceId, interfaceId, methodId) {
                // 移除之前的选中状态
                document.querySelectorAll('.method-item.is-active').forEach(el => {
                    el.classList.remove('is-active');
                });

                // 添加当前选中状态
                event.target.closest('.method-item').classList.add('is-active');

                const service = this.services.find(s => s.id === serviceId);
                const iface = service.interfaces.find(i => i.id === interfaceId);
                const method = iface.methods.find(m => m.id === methodId);

                this.currentMethod = {
                    serviceId,
                    interfaceId,
                    methodId,
                    service,
                    interface: iface,
                    method
                };

                this.showTestPanel();
            }

            showTestPanel() {
                document.getElementById('welcome-panel').style.display = 'none';
                document.getElementById('test-panel').classList.add('is-active');

                const { service, interface: iface, method } = this.currentMethod;

                document.getElementById('method-title').textContent = `测试: ${method.name}`;
                document.getElementById('interface-name').value = iface.name; // 显示完整接口名
                document.getElementById('method-name').value = method.name;
                document.getElementById('params-input').value = method.params;

                // 隐藏之前的结果
                document.getElementById('result-panel').style.display = 'none';
            }

            testMethod() {
                if (!this.currentMethod) {
                    alert('请先选择要测试的方法');
                    return;
                }

                const params = document.getElementById('params-input').value;

                this.socket.emit('test-method', {
                    serviceId: this.currentMethod.serviceId,
                    interfaceId: this.currentMethod.interfaceId,
                    methodId: this.currentMethod.methodId,
                    params: params
                });
            }

            formatJsonParams() {
                const paramsInput = document.getElementById('params-input');
                const currentValue = paramsInput.value.trim();
                
                if (!currentValue) {
                    alert('请先输入JSON内容');
                    return;
                }

                try {
                    // Parse and format JSON
                    const parsed = JSON.parse(currentValue);
                    const formatted = JSON.stringify(parsed, null, 2);
                    paramsInput.value = formatted;
                } catch (error) {
                    alert('JSON格式错误: ' + error.message);
                }
            }

            formatMethodJsonParams() {
                const paramsInput = document.getElementById('method-params');
                const currentValue = paramsInput.value.trim();
                
                if (!currentValue) {
                    alert('请先输入JSON内容');
                    return;
                }

                try {
                    // Parse and format JSON
                    const parsed = JSON.parse(currentValue);
                    const formatted = JSON.stringify(parsed, null, 2);
                    paramsInput.value = formatted;
                } catch (error) {
                    alert('JSON格式错误: ' + error.message);
                }
            }

            showLoading(message) {
                const resultPanel = document.getElementById('result-panel');
                const resultContent = document.getElementById('result-content');
                
                resultPanel.style.display = 'block';
                resultContent.className = 'result-content loading';
                resultContent.textContent = message;
            }

            showResult(data, type) {
                const resultPanel = document.getElementById('result-panel');
                const resultContent = document.getElementById('result-content');
                
                resultPanel.style.display = 'block';
                resultContent.className = `result-content ${type}`;
                
                if (typeof data === 'object') {
                    resultContent.textContent = JSON.stringify(data, null, 2);
                } else {
                    resultContent.textContent = data;
                }
            }

            showError(message) {
                this.showResult(message, 'error');
            }

            // 测试连接
            async testConnection(serviceId) {
                const service = this.services.find(s => s.id === serviceId);
                if (!service) {
                    alert('未找到服务');
                    return;
                }

                try {
                    // 显示加载状态
                    const result = document.getElementById('result-panel') || document.createElement('div');
                    result.style.display = 'block';
                    result.innerHTML = `
                        <div class="result-header"><i class="fas fa-search"></i> 连接测试</div>
                        <div class="result-content loading">正在测试连接到 ${service.dubbo_config.host}:${service.dubbo_config.port}...</div>
                    `;
                    
                    // 如果结果面板不存在，添加到页面
                    if (!document.getElementById('result-panel')) {
                        result.id = 'result-panel';
                        result.className = 'result-panel';
                        document.querySelector('.content-area').appendChild(result);
                    }

                    const response = await fetch('/api/test-connection', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ serviceId })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        const testResult = data.data;
                        if (testResult.success) {
                            result.innerHTML = `
                                <div class="result-header"><i class="fas fa-search"></i> 连接测试结果</div>
                                <div class="result-content success">
<i class="fas fa-check text-success"></i> ${testResult.message}
<i class="fas fa-clock"></i> 响应时间: ${testResult.elapsed}ms
🌐 地址: ${service.dubbo_config.host}:${service.dubbo_config.port}

💡 连接正常，可以进行接口调用测试
                                </div>
                            `;
                        } else {
                            result.innerHTML = `
                                <div class="result-header"><i class="fas fa-search"></i> 连接测试结果</div>
                                <div class="result-content error">
<i class="fas fa-times text-danger"></i> 连接失败: ${testResult.error}
🌐 地址: ${service.dubbo_config.host}:${service.dubbo_config.port}
📋 错误代码: ${testResult.errorCode || '未知'}

🔧 可能的解决方案:
• 检查Dubbo服务是否已启动
• 确认服务地址和端口是否正确
• 检查网络连接和防火墙设置
• 验证服务是否在指定端口监听
                                </div>
                            `;
                        }
                    } else {
                        result.innerHTML = `
                            <div class="result-header"><i class="fas fa-search"></i> 连接测试结果</div>
                            <div class="result-content error"><i class="fas fa-times text-danger"></i> 测试失败: ${data.error}</div>
                        `;
                    }
                } catch (error) {
                    const result = document.getElementById('result-panel');
                    if (result) {
                        result.innerHTML = `
                            <div class="result-header"><i class="fas fa-search"></i> 连接测试结果</div>
                            <div class="result-content error"><i class="fas fa-times text-danger"></i> 网络错误: ${error.message}</div>
                        `;
                    }
                }
            }

            // 切换服务折叠状态
            toggleService(serviceId) {
                const interfacesContainer = document.getElementById(`interfaces-${serviceId}`);
                const icon = document.getElementById(`service-icon-${serviceId}`);
                
                if (interfacesContainer.classList.contains('expanded')) {
                    interfacesContainer.classList.remove('expanded');
                    icon.innerHTML = '<i class="fas fa-chevron-right"></i>';
                    icon.classList.remove('expanded');
                    this.collapsedStates.services[serviceId] = false;
                } else {
                    interfacesContainer.classList.add('expanded');
                    icon.innerHTML = '<i class="fas fa-chevron-down"></i>';
                    icon.classList.add('expanded');
                    this.collapsedStates.services[serviceId] = true;
                }
                
                this.saveCollapsedStates();
            }

            // 切换接口折叠状态
            toggleInterface(serviceId, interfaceId) {
                const methodsContainer = document.getElementById(`methods-${serviceId}-${interfaceId}`);
                const icon = document.getElementById(`interface-icon-${serviceId}-${interfaceId}`);
                
                if (methodsContainer.classList.contains('expanded')) {
                    methodsContainer.classList.remove('expanded');
                    icon.innerHTML = '<i class="fas fa-chevron-right"></i>';
                    icon.classList.remove('expanded');
                    this.collapsedStates.interfaces[`${serviceId}-${interfaceId}`] = false;
                } else {
                    methodsContainer.classList.add('expanded');
                    icon.innerHTML = '<i class="fas fa-chevron-down"></i>';
                    icon.classList.add('expanded');
                    this.collapsedStates.interfaces[`${serviceId}-${interfaceId}`] = true;
                }
                
                this.saveCollapsedStates();
            }

            // 保存折叠状态到localStorage
            saveCollapsedStates() {
                localStorage.setItem('dubbo-test-collapsed-states', JSON.stringify(this.collapsedStates));
            }

            // 从localStorage加载折叠状态
            loadCollapsedStates() {
                const saved = localStorage.getItem('dubbo-test-collapsed-states');
                if (saved) {
                    this.collapsedStates = JSON.parse(saved);
                }
            }

            // 应用折叠状态
            applyCollapsedStates() {
                // 应用服务折叠状态
                Object.keys(this.collapsedStates.services).forEach(serviceId => {
                    const interfacesContainer = document.getElementById(`interfaces-${serviceId}`);
                    const icon = document.getElementById(`service-icon-${serviceId}`);
                    
                    if (interfacesContainer && icon) {
                        if (this.collapsedStates.services[serviceId]) {
                            interfacesContainer.classList.add('expanded');
                            icon.innerHTML = '<i class="fas fa-chevron-down"></i>';
                            icon.classList.add('expanded');
                        } else {
                            interfacesContainer.classList.remove('expanded');
                            icon.innerHTML = '<i class="fas fa-chevron-right"></i>';
                            icon.classList.remove('expanded');
                        }
                    }
                });

                // 应用接口折叠状态
                Object.keys(this.collapsedStates.interfaces).forEach(key => {
                    const methodsContainer = document.getElementById(`methods-${key}`);
                    const icon = document.getElementById(`interface-icon-${key}`);
                    
                    if (methodsContainer && icon) {
                        if (this.collapsedStates.interfaces[key]) {
                            methodsContainer.classList.add('expanded');
                            icon.innerHTML = '<i class="fas fa-chevron-down"></i>';
                            icon.classList.add('expanded');
                        } else {
                            methodsContainer.classList.remove('expanded');
                            icon.innerHTML = '<i class="fas fa-chevron-right"></i>';
                            icon.classList.remove('expanded');
                        }
                    }
                });
            }
        }

        // 初始化应用
        const app = new DubboTestUI();
    </script>
</body>
</html>